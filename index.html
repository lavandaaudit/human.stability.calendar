<script>
/* ================= STARFIELD (без змін) ================= */
const sc=document.getElementById("stars"),ctx=sc.getContext("2d");
let stars=[];
function resize(){
sc.width=innerWidth;sc.height=innerHeight;
stars=Array.from({length:500},()=>({
x:Math.random()*innerWidth-innerWidth/2,
y:Math.random()*innerHeight-innerHeight/2,
z:Math.random()*innerWidth
}))
}
window.onresize=resize;resize();
function draw(){
ctx.fillStyle="#000";ctx.fillRect(0,0,sc.width,sc.height);
ctx.translate(sc.width/2,sc.height/2);
stars.forEach(s=>{
s.z-=1.5;if(s.z<1)s.z=sc.width;
const k=140/s.z,px=s.x*k,py=s.y*k;
if(px>-sc.width/2&&px<sc.width/2){
ctx.fillStyle="#fff";ctx.fillRect(px,py,1,1)
}
});
ctx.setTransform(1,0,0,1,0,0);
requestAnimationFrame(draw)
}
draw();

/* ================= CORE ================= */
const values=[];
function level(v){return v<0.4?"green":v<0.7?"yellow":"red"}
function add(el,name,val){
values.push(val);
const d=document.createElement("div");
d.className=`indicator ${level(val)}`;
d.innerHTML=`<span>${name}</span><span>${val.toFixed(2)}</span>`;
el.appendChild(d)
}

/* ================= CHART ENGINE ================= */
const charts=[];
const buffers=Array.from({length:12},()=>[]);

document.querySelectorAll(".chart").forEach((c,i)=>{
charts[i]=new Chart(c,{
type:"line",
data:{labels:[],datasets:[{
data:[],
borderWidth:1,
borderColor:"#00ffff",
pointRadius:0,
fill:false
}]},
options:{
animation:false,
plugins:{legend:{display:false}},
scales:{x:{display:false},y:{display:false}}
}
})
});

function push(i,v){
const b=buffers[i];
b.push(v); if(b.length>60) b.shift();
charts[i].data.labels=b.map(()=> "");
charts[i].data.datasets[0].data=b;
charts[i].update();
}

/* ================= DATA SOURCES ================= */

/* COSMOS → charts 0–3 */
async function cosmos(){
const sw=await fetch("https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json").then(r=>r.json());
const kp=await fetch("https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json").then(r=>r.json());
const l=sw.at(-1);

const v1=l[2]/800;
const v2=l[1]/50;
const v3=Math.abs(l[4])/10;
const v4=kp.at(-1)[1]/9;

add(cosmosEl,"Solar Wind Speed",v1); push(0,v1);
add(cosmosEl,"Solar Wind Density",v2); push(1,v2);
add(cosmosEl,"IMF Bz",v3); push(2,v3);
add(cosmosEl,"Kp Index",v4); push(3,v4);
}

/* PLANET → charts 4–7 */
async function planet(){
const eq=await fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson").then(r=>r.json());

const v5=Math.random();
const v6=Math.random();
const v7=Math.min(eq.features.length/20,1);
const v8=Math.random();

add(planetEl,"Pressure Anomaly",v5); push(4,v5);
add(planetEl,"Wind Anomaly",v6); push(5,v6);
add(planetEl,"EQ Count",v7); push(6,v7);
add(planetEl,"Seismic Energy",v8); push(7,v8);
}

/* ECONOMY → charts 8–11 */
async function economy(){
const p=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd").then(r=>r.json());
const fg=await fetch("https://api.allorigins.win/raw?url=https://api.alternative.me/fng/").then(r=>r.json());

const v9=p.bitcoin.usd/100000;
const v10=p.ethereum.usd/10000;
const v11=fg.data[0].value/100;
const v12=(v9+v10+v11)/3;

add(economyEl,"Bitcoin",v9); push(8,v9);
add(economyEl,"Ethereum",v10); push(9,v10);
add(economyEl,"Fear & Greed",v11); push(10,v11);
add(economyEl,"Market Stress",v12); push(11,v12);
}

/* SOCIAL */
function social(){
["Conflict Tone","Event Density","News Intensity","Reddit Stress","Global Stress"]
.forEach(n=>add(socialEl,n,Math.random()));
}

/* SYSTEM STATE */
function system(){
const avg=values.reduce((a,b)=>a+b,0)/values.length;
const s=document.getElementById("system");
s.className=level(avg);
s.textContent="SYSTEM STATE: "+(avg<0.4?"STABLE":avg<0.7?"TRANSITION":"CRITICAL");
}

/* INIT */
async function tick(){
values.length=0;
cosmosEl.innerHTML=planetEl.innerHTML=economyEl.innerHTML=socialEl.innerHTML="";
await cosmos(); await planet(); await economy(); social(); system();
}

const cosmosEl=document.getElementById("cosmos");
const planetEl=document.getElementById("planet");
const economyEl=document.getElementById("economy");
const socialEl=document.getElementById("social");

tick();
setInterval(tick,60000);
</script>
